@using System.Globalization
@using System.Resources
@using Microsoft.AspNetCore.Http
@using Snitz.Events.Models
@using SnitzCore.Service.Extensions
@model dynamic

@{
    //Layout = "Layout";
    ViewBag.Title = SnitzConfig.ForumTitle + " | " + @Localizer["calTitle"];
    string[] rtlLangs = new string[] { "ar", "arc", "dv", "fa", "ha", "khw", "ks", "ku", "ps", "ur", "yi", "he" };

    CultureInfo ci = CultureInfo.CurrentUICulture;
    string clang = ci.TwoLetterISOLanguageName;
    //check the culture so we can set the page direction and language
    var cookielang = SnitzCookie.GetCookieValue("CookieLang");
    if (cookielang != null)
    {
        var cultureInfo = new CultureInfo(cookielang);
        CultureInfo.CurrentUICulture = cultureInfo;
        clang = cultureInfo.TwoLetterISOLanguageName;
    }
    Context.Session.SetString("culture", clang);
    bool isRighToLeft = rtlLangs.Contains(clang);
    clang = clang + ".global.min.js";

    var countries = (List<EnricoCountry>)ViewData["Countries"];

}
@section Styles {
    <link rel="stylesheet" href="~/_content/Snitz.Events/css/jquery-ui-timepicker-addon.min.css">
}
<div class="chunk-main">
    <snitz-breadcrumb show-filter="false"></snitz-breadcrumb>
    <h5>@Localizer["calTitle"]</h5>
    <hr class="title" />
    <div class="row">
        <div class="col-3 ">
            @Html.DropDownList("STRCALCOUNTRY",
            new SelectList(countries, "countryCode", "fullName", "gbr"),
                        "Select Country",
                        new { @class = "form-select", @id = "change-holidays" })
        </div>
        <div class="col-3">
            <select class="form-select d-none" name="STRCALREGION" id="countryRegion" >
                <option value=''>No Regions</option>
            </select>
        </div>
        <span snitz-if="@(SnitzConfig.GetValue("STRCALCOUNTRY") != "")" class="col-10 form-text">Public holiday data supplied by <a href="http://kayaposoft.com/enrico/" title="Enrico Service is a free service written in PHP providing public holidays for several countries" data-toggle="tooltip">Enrico</a></span>

        @* <select id="locale-selector"></select> *@
    </div>
    <div class="row-fluid">
        <div id="calendar"></div>
    </div>
    <div class="row-fluid"></div>
</div>
@section Scripts {
    <script type="text/javascript">
        var upComingEventsTitle = '[@Localizer["upComingEventTitle"]]';
        var pastEventsTitle = '[@Localizer["upPastEventsTitle"]]';
    </script>
    <environment include="Development">
        <script src="~/js/pluginjs/snitz.cal.js"></script>
    </environment>
    <environment exclude="Development">
        <script src="~/js/pluginjs/snitz.cal.min.js" asp-append-version="true"></script>
    </environment>
    <script src='~/_content/Snitz.Events/js/dist/index.global.min.js'></script>
    <script src="~/_content/Snitz.Events/js/locales-all.global.min.js"></script>
    <script type="text/javascript">

        $(document)
            .ready(function () {
                let selectedCountry = localStorage.getItem('pubCountry');
                if(selectedCountry !== "null" && selectedCountry !== null){
                    $('#change-holidays').val(selectedCountry);
                    FullCalendarNew("@Url.Action("GetCalendarEvents")", 'calendar', '@SnitzConfig.GetValue("INTFIRSTDAYOFWEEK")', selectedCountry);

                }else{
                    FullCalendarNew("@Url.Action("GetCalendarEvents")", 'calendar', '@SnitzConfig.GetValue("INTFIRSTDAYOFWEEK")', 'gbr');
                    $('#change-holidays').val('gbr');
                }
                populateRegions($('#change-holidays').val());
            });

        function populateRegions(country) {
            var subItems = "";
            $.getJSON("@Url.Action("GetRegions", "Calendar")", { id: country }, function (data) {

                $.each(data, function (index, item) {
                if (item === '@SnitzConfig.GetValue("STRCALREGION")') {
                        subItems += "<option value='" + item + "' selected>" + item + "</option>";
                    } else {
                        subItems += "<option value='" + item + "'>" + item + "</option>";
                    }
                });
                if (subItems.length > 1) {
                    subItems = "<option value=''>Select Region</option>" + subItems;
                    $("#countryRegion").html(subItems);
                    $("#countryRegion").show();
                } else {
                    subItems = "<option value='' selected>No Regions</option>";
                    $("#countryRegion").html(subItems);
                    $("#countryRegion").hide();
                }

            });
        }
    </script>
}