@model MVCForum.ViewModels.Forum.ForumIndexModel
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using BbCodeFormatter
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Routing
@using MVCForum.TagHelpers
@using MVCForum.ViewModels.User
@inject SignInManager<ForumUser> SignInManager
@inject ICodeProcessor BbCodeProcessor
@{
    var cat = Context.Request.Query["id"];
    var test = Context.GetRouteValue("id");
    if (test != null)
    {
        cat = (string)test;
    }
}
<div class="container pt-0">
    <snitz-breadcrumb></snitz-breadcrumb>
    @if (User.IsInRole("Administrator"))
    {
        if (!string.IsNullOrWhiteSpace(cat))
        {
            <form>
                <div class="btn-group mb-2">
                    <button asp-controller="Category" type="submit" asp-action="Edit" asp-route-id="@cat" title="@Localizer["tipEditCategory"]" class="btn btn-outline-warning"><i class="fa fa-pencil"></i><span class="d-none d-md-inline"> @Localizer["tipEditCategory"]</span></button>
                    <button-confirm selector="confirm-delete" config-class="fa fa-trash" config-key="@cat" href="/Category/Delete/?id=" title="@Localizer["cnfDeleteCategory"].Value"></button-confirm>
                    <button asp-controller="Forum" type="submit" asp-action="Create" asp-route-id="@cat" title=" @Localizer["tipNewForum"]" class="btn btn-outline-success"><i class="fa fa-folder"></i><span class="d-none d-md-inline"> @Localizer["tipNewForum"]</span></button>
                </div>
            </form>
        }
        else
        {
            <form >
                <div class="btn-group mb-2">
                    <button asp-controller="Category" type="submit" asp-action="Create" title="@Localizer["tipNewCategory"]" class="btn btn-outline-warning"><i class="fa fa-folder-open"></i><span class="d-none d-md-inline"> @Localizer["tipNewCategory"]</span></button>
                    <button asp-controller="Forum" type="submit" asp-action="Create" title="@Localizer["tipNewForum"]" class="btn btn-outline-warning"><i class="fa fa-folder"></i><span class="d-none d-md-inline"> @Localizer["tipNewForum"]</span></button>
                </div>
            </form>
        }
    }


    <div class="row">
        <div class="col">
            @foreach (var categoryForums in Model.ForumList?.GroupBy(f => f.CategoryId)!)
            {
                <div class="subforum border-1 border-primary">
                    <div class="subforum-title rounded">
                        <h1 style="display: inline-block;"><a href="/Category/@categoryForums.Key">@categoryForums.FirstOrDefault()?.CategoryName</a></h1>
                    </div>
                    @foreach (var forum in categoryForums)
                    {
                        @if (HasAccess(forum.AccessType, forum.Id))
                        {
                            var weblinkclass = "";
                            if (forum.ForumType == ForumType.WebLink)
                            {
                                weblinkclass = "subforum-weblink";
                            }
                            <div class="subforum-row @weblinkclass">
                                <div class="subforum-icon subforum-column center">
                                    <snitz-forum-icon status="@forum.Status" forumtype="@((int)forum.ForumType)" accesstype="@((int)forum.AccessType)"></snitz-forum-icon>
                                </div>
                                <div class="subforum-description subforum-column">
                                    @if (forum.ForumType == ForumType.WebLink)
                                    {
                                        <h4><a href="@forum.Url" target="_blank" title="">@Html.Raw(BbCodeProcessor.Subject(forum.Title))</a></h4>
                                    }
                                    else
                                    {
                                        
                                        <h4><a href="/Forum/@forum.Id/?defaultdays=@((int)forum.DefaultView)" title="Go to @forum.Title">@Html.Raw(BbCodeProcessor.Subject(forum.Title))</a></h4>
                                    }
                                    <p>@Html.Raw(BbCodeProcessor.Format(forum.Description))</p>
                                </div>
                                @if (forum.ForumType != ForumType.WebLink)
                                {
                                    <div class="subforum-stats subforum-column">
                                        <span>@forum.Posts @Localizer["lblPosts"] @Localizer["lblin"] @forum.Topics @Localizer["lblTopics"]</span>
                                    </div>
                                    <div class="subforum-info subforum-column">
                                        @if (forum.LastPostTopicId.HasValue)
                                        {
                                            <text>@Localizer["lblPostedBy"]</text>
                                            <member-link member-id="@forum.LastPostAuthorId" text-localizer-delegate="delegate(string s) { return Localizer[s].Value; }"></member-link>
                                            <br class="d-none d-sm-block"/><lastpost-link reply-id="@forum.LastPostReplyId" post-date="@forum.LastPostDateTime" topic-id="@forum.LastPostTopicId.Value" text-localizer-delegate="delegate(string s) { return Localizer[s].Value; }"></lastpost-link>
                                        }
                                    </div>
                                }
                            </div>
                            <hr class="subforum-divider">
                        }
                    }
                </div>
            }
        </div>
        <div class="d-none d-lg-block col-3">
            <partial name="QuickSearch"/>
            <partial name="LoginForm" model="new UserSignInModel()" />
            <partial name="LatestPosts" model="@Model.LatestPosts"/>
        </div>
    </div>
    <partial name="ForumStats" />
</div>
@{
    var confModel = new ConfirmDialogViewModel() { 
        Title = "Delete Category", 
        Message = @"<p>You are about to delete this Category.</p>
                <p>Do you wish to proceed?</p>" };
}
<partial name="ConfirmDialog" model="@confModel" />

@functions
{
    bool HasAccess(ForumAuthType authType,int forumId)
    {
        switch (authType)
        {
            case ForumAuthType.All:
                return true;
            case ForumAuthType.AllowedMembers:
                if (SignInManager.IsSignedIn(User) && (User.IsInRole("Forum_" + forumId) || User.IsInRole("Administrator")))
                {
                    return true;
                }
                return false;
            case ForumAuthType.PasswordProtected:
                return true;
            case ForumAuthType.AllowedMemberPassword:
                // if (SignInManager.IsSignedIn(User) && (User.IsInRole("Forum_" + forumId) || User.IsInRole("Administrator")))
                // {
                //     return true;
                // }
                return true;
            case ForumAuthType.Members:
                // if (SignInManager.IsSignedIn(User))
                //     return true;
                return true;
            case ForumAuthType.MembersHidden:
                return false;
            case ForumAuthType.AllowedMembersHidden:
                return false;
            case ForumAuthType.MembersPassword:
                // if (SignInManager.IsSignedIn(User))
                //     return true;
                return true;

        }

        return false;
    }
}
@section Scripts
{
    <script type="text/javascript" src="/js/ConfirmDialog.js" crossorigin="anonymous"></script>
}
    
