@model MVCForum.ViewModels.Forum.ForumSearchModel
@using Microsoft.AspNetCore.Mvc.TagHelpers

@using SmartBreadcrumbs
@using SnitzCore.Data.Extensions
@using System.ComponentModel.DataAnnotations
@{
    ViewBag.PageCount = Model.Results?.PageCount!;
    string pagenum = (Model.Results?.PageNum?.ToString() ?? Context.Request.Query["page"])!;
    ViewBag.PageNum = pagenum;

}
@section MetaData
{
    <title>Search - @Config.Value.strForumTitle </title>
    <meta name="title" content="Search - @Config.Value.strForumTitle" />
    <meta name="copyright" content="@Html.Raw(String.Format(SnitzConfig.Copyright, DateTime.UtcNow.Year)) - @SnitzConfig.ForumTitle">
    <meta name="robots" content="index,nofollow" />

}
@section Styles{
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/css/bootstrap-datepicker3.min.css">
    <link href="~/css/star-rating.min.css" rel="stylesheet" />
    <link href="~/css/krajee-svg/theme.min.css" media="all" rel="stylesheet" type="text/css" />
}
    <div class="pt-0">
        <!--Navigation-->
    <snitz-breadcrumb></snitz-breadcrumb>

    @if (Model.Results != null && Model.Results.Posts != null && Model.Results.Posts.Any())
    {
        @if (SnitzConfig.GetValueWithDefault("STRSEARCHPAGESIZES", "") != "")
        {
            <div class="input-group mb-3">
                <div class="radioBtn btn-group btn-group-sm" title="Page size" data-toggle="tooltip" data-original-title="Page size">
                    @foreach (var size in SnitzConfig.GetValueWithDefault("STRSEARCHPAGESIZES", "")!.Split(","))
                    {
                        <a class="btn btn-outline-secondary btn-sm notActive" data-toggle="fun" data-title="@size">@size</a>
                    }
                </div>
                <span class="form-text">&nbsp;@Localizer["lblPageSize"]</span>
                <input type="hidden" name="fun" id="fun">
            </div>
        }

        <!--Display posts table-->
        <div class="posts-table mb-3">
            <partial name="TopicListingHeader" />
            @{
                ViewData["ActiveTopics"] = true;
            }
            <!--Topics start here-->
            @foreach (var post in Model.Results.Posts!)
            {
                if (post.ArchivedTopic != null)
                {
                    <partial name="ArchivedTopicListing" model="post" view-data="ViewData" />
                }
                else if (post.Topic != null)
                {
                    <partial name="TopicListing" model="post" view-data="ViewData" />
                }
                
            }
            <!--ends here-->
        </div>
        <!--Pagination starts-->
        <partial snitz-if="@(Model.Results.PageCount > 1)" name="ListPaging" model="@(new PagingModel
                                                                                    {
                                                                                        PageCount = Model.Results.PageCount,
                                                                                        PageSize = Model.Results.PageSize,
                                                                                        Page = Convert.ToInt32(pagenum)
                                                                                    })" />
        <!--pagination ends-->
        <partial name="IconInfo" />
    }
    else
    {
        var allterms = Localizer[SearchFor.AllTerms.GetAttribute<DisplayAttribute>()!.Name!].Value;
        var anyterms = Localizer[SearchFor.AnyTerms.GetAttribute<DisplayAttribute>()!.Name!].Value;
        <div class="col col-md-10 offset-md-1 ">
            <form asp-controller="Forum" asp-action="SearchResult" class="needs-validation bg-form p-4 rounded" novalidate>
                <legend>@Localizer["btnSearch"]</legend>
                <div class="row mb-3">
                    <div class="col-6">
                        <input asp-for="Terms" type="text" class="form-control" placeholder="@Localizer["plhSearchTerm"]" aria-label="@Localizer["plhSearchTerm"]" aria-describedby="button-addon2">
                        <i class="fa fa-sliders"></i><button class="btn btn-link" type="button" id="button-addon2" title="@Localizer["tipAdvancedSearch"]" data-bs-toggle="collapse" data-bs-target="#showFilters" aria-expanded="false" data-toggle="tooltip">@Localizer["tipAdvancedSearch"]</button>
                        <div class="invalid-feedback">@Localizer["PropertyRequired", ""]</div>
                    </div>
                    <div class="col-4">
                        <select id="SearchFor" name="SearchFor" class="form-select">
                        @foreach (SearchFor c in Enum.GetValues(typeof(SearchFor)).OfType<SearchFor>())
                        {
                            var displayName = c.GetAttribute<DisplayAttribute>()!.Name!;
                            <option value="@((int)c)" selected-val="@Model.SearchFor">@Localizer[displayName]</option>
                        }
                        </select>

                    </div>
                    <div class="col"><button type="submit" id="btn-submit" value="Search" class="btn btn-success btn-small"><i class="fa fa-search"></i> @Localizer["btnSearch"]</button></div>
                </div>

                <div class="collapse" id="showFilters">
                <div class="row mb-3">
                    <div class="col-12 col-md-6">
                        <label for="SearchMessage" class="form-label">@Localizer["lblSearchin"]</label>
                        <select id="SearchMessage" name="SearchMessage" class="form-select">
                            <option value="True" selected-val="@Model.SearchMessage">v</option>
                            <option value="False" selected-val="@Model.SearchMessage">@Localizer["SearchIn_Subject"]</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-6">
                        <label for="SinceWhen" class="form-label">@Localizer["lblPosted"]</label>
                        <div class="row">
                            <div class="col">
                                <select id="SinceWhen" name="SinceWhen" class="form-select">
                                    <option value="before" selected-val="@Model.SinceWhen">@Localizer["Search_Before"]</option>
                                    <option value="after" selected-val="@Model.SinceWhen">@Localizer["Search_After"]</option>
                                </select>
                            </div>
                            <div class="col">
                                <div class="input-group date" data-provide="datepicker" id="datepicker">
                                    <input type="text" class="form-control" placeholder="dd/mm/yyyy" name="SinceDate">
                                    <div class="input-group-addon">
                                        <button type="button" class="btn btn-outline-secondary"><i class="fa fa-calendar"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <label for="UserName" class="form-label">@Localizer["Search_Member"]</label>
                        <div class="input-group">
                            <span class="input-group-text" id="basic-addon1"><i class="fa fa-user"></i></span>
                            <input id="UserName" name="UserName" placeholder="@Localizer["plhUsername"]" type="text" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12 col-md-6">
                        <label for="ddlSearchCategory" class="form-label">@Localizer["Search_Category"]</label>
                        <select id="ddlSearchCategory" name="SearchCategory" asp-items="Model.Categories" aria-describedby="selectHelpBlock" class="form-select">
                            <option value="0">@Localizer["Search_AllCategories"]</option>
                        </select>
                        <span id="selectHelpBlock" class="form-text text-muted">@Localizer["Search_CatDesc"]</span>
                    </div>
                    <div class="col-12 col-md-6">
                        <label for="SearchForums" class="form-label">@Localizer["Search_Forum"]</label>
                        <select multiple="multiple" id="SearchForums" name="SearchForums" asp-items="Model.Forums" aria-describedby="select1HelpBlock" class="form-select">
                            <option value="" selected>@Localizer["mnuForumAll"]</option>
                        </select>
                        <span id="select1HelpBlock" class="form-text text-muted">@Localizer["Search_ForumDesc"]</span>
                    </div>
                </div>

                <div class="row mb-3" >
                    <div class="col-2">
                        <label class="form-label">@Localizer["Search_Archive"]</label>
                    </div>
                    <div class="col">
                        <div class="form-check form-check-inline">
                            <input asp-for="SearchArchives" id="SearchArchivesOn" type="radio" class="form-check-input" value="true" aria-describedby="radio1HelpBlock">
                            <label for="SearchArchivesOn" class="form-check-label">@Localizer["lblYes"]</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input asp-for="SearchArchives" id="SearchArchivesOff" type="radio" class="form-check-input" value="false" aria-describedby="radio1HelpBlock">
                            <label for="SearchArchivesOff" class="form-check-label">@Localizer["lblNo"]</label>
                        </div>
                    </div>
                    <span id="radio1HelpBlock" class="form-text text-muted">@Localizer["Search_ArchiveDesc"]</span>
                </div>
                </div>
            </form>
        </div>
    }
    </div>
<form id="searchModel" method="POST">
    @Html.HiddenFor(m => m.Terms)
    @Html.HiddenFor(m => m.SearchFor)
    @Html.HiddenFor(m => m.SearchMessage)
    @Html.HiddenFor(m => m.SinceDate)
    @Html.HiddenFor(m => m.SinceWhen)
    @Html.HiddenFor(m => m.SearchArchives)
    @Html.HiddenFor(m => m.UserName)
    @Html.HiddenFor(m => m.SearchCategory)
    @Html.HiddenFor(m => m.SearchForums)
</form>
@section Scripts{
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js"></script>
    <script src="~/js/star-rating.min.js"></script>
    <script src="~/js/krajee-svg/theme.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="~/js/postcontroller.min.js"></script>
    <script type="text/javascript">
        $(document).on('click', '.page-link', function (e) {
            e.preventDefault();
            console.log($(this).attr("href"));
                // var form = document.getElementById('searchModel');
                // var formData = new FormData(form);
                $('#searchModel').attr('action', SnitzVars.baseUrl + '/Forum/SearchResult/' + $(this).attr("href"));
                $('#searchModel').submit();

            return false;
        });
        // Disable form submissions if there are invalid fields
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                ValidateForms();
            }, false);
        })();
        $(window).on("load",
            function(e) {
                $('.rb-rating').rating({
                    'showCaption': false,
                    'displayOnly':true
                });
            });
        var pagesizeCookie = 'search' + "-pagesize";
        if ($.cookie(pagesizeCookie)) {
            var storedSize = parseInt($.cookie(pagesizeCookie));
            $('a[data-toggle="fun"]')
                .not('[data-title="' + storedSize + '"]')
                .removeClass('active')
                .addClass('notActive');
            $('a[data-toggle="fun"][data-title="' + storedSize + '"]')
                .removeClass('notActive')
                .addClass('active');
        }
        $('body')
            .on('click', '.radioBtn a',
                function () {
                    var sel = $(this).data('title');
                    var tog = $(this).data('toggle');
                    $('#' + tog).prop('value', sel);
                    $('a[data-toggle="' + tog + '"]')
                        .not('[data-title="' + sel + '"]')
                        .removeClass('active')
                        .addClass('notActive');
                    $('a[data-toggle="' + tog + '"][data-title="' + sel + '"]')
                        .removeClass('notActive')
                        .addClass('active');
                    if (!$.cookie(pagesizeCookie)) {
                        var testCookie = 'cookie support check';
                        $.cookie(testCookie, true,{ path: SnitzVars.cookiePath });
                        if ($.cookie(testCookie)) { // browser supports cookie
                            $.cookie(testCookie, null,{ path: SnitzVars.cookiePath });
                            $.removeCookie(testCookie);
                            $.cookie(pagesizeCookie, sel, { expires: 1, path: window.SnitzVars.cookiePath /*, domain: window.SnitzVars.cookieDomain*/ });
                            location.reload(); // re-load the page
                        }
                    } else {
                        var storedSize = parseInt($.cookie(pagesizeCookie));
                        var currentSize = parseInt(sel);
                        if (storedSize !== currentSize) { // user may have changed the pagesize
                            $.cookie(pagesizeCookie, sel, { expires: 1, path: window.SnitzVars.cookiePath /*, domain: window.SnitzVars.cookieDomain*/ });
                            location.reload();
                        }
                    }
                });
        $.fn.datepicker.defaults.format = "mm/dd/yyyy";

            $(function () {
                $('#datepicker').datepicker({

                    format: {
                        /*
                         * Convert to Forum datestring format,
                         */

                        toDisplay: function (date, format, language) {
                            var d = new Date(date);
                            d.setDate(d.getDate());
                            return d.toLocaleDateString();
                        },
                        toValue: function (date, format, language) {
                            let re = /([0-9]{4})([0-9]{2})([0-9]{2})/;
                            let lastFirst = date.replace(re, '$1-$2-$3');
                            var d = new Date(lastFirst);
                            d.setDate(d.getDate());
                            return new Date(d);
                        }
                    }
                });

            });
    </script>
}
