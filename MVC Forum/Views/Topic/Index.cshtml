@model MVCForum.ViewModels.Post.PostIndexModel
@using BbCodeFormatter
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using MVCForum.TagHelpers
@using SmartBreadcrumbs
@using Snitz.Events.Helpers
@using SnitzCore.Data
@using SnitzCore.Service.TagHelpers
@inject ICodeProcessor BbCodeProcessor
@inject SignInManager<ForumUser> SignInManager
@inject IEnumerable<ISnitzStartupService> pluginservices
@section MetaData
{
    <meta name="title" content="Topic: @Model.Title" />
    <meta name="description" content="@Model.Content" />
    <meta name="robots" content="index,nofollow" />
}
@section Styles
{
    <link rel="stylesheet" href="~/css/prism.min.css">

    @if (ViewBag.RequireAuth)
    {
        <style>
            .modal-backdrop
            {
                opacity:1.0 !important;
            }
            .modal-backdrop.in {
                opacity: 1.0 !important;
            }
        </style>
    }
}
@if (!(bool)ViewBag.RequireAuth)
{
    var eventservice = pluginservices.FirstOrDefault(t => t.GetType() == typeof(CalEventsService));
    ViewBag.PageCount = Model.PageCount;
    var currmember = MemberService.Current();
    string pagenum = (Model.PageNum.ToString() ?? Context.Request.Query["page"])! ;
    var replyClass = "d-none";
    var loggedin = SignInManager.IsSignedIn(User);
    if (loggedin)
    {
        replyClass = "";
    }
    var show1 = SnitzConfig.GetIntValue("INTTOPICDISPLAY") == 1 || (@SnitzConfig.GetIntValue("INTTOPICDISPLAY") != 1 && int.Parse(@pagenum) < 2);

<div class="container pt-0">
    <snitz-breadcrumb></snitz-breadcrumb>
    <!--Topic Section-->
        <vc:topic-buttons postid="@Model.Id" topic-email="@(loggedin ? 1 : 0)"></vc:topic-buttons>
        <div snitz-if="@show1" class="card mb-2 topic-container">
        @{
            var answer = "";
            if (Model.Answered)
            {
                answer = "bg-success";
            }
        }
        <div class="card-header @answer modstatus-@Model.Status">
            @Model.Title - <span class="form-text">@Localizer["lblPosted"] <snitz-datetime datetime="@Model.Created"></snitz-datetime> (@Model.Views @Localizer["Views"])</span>
            <a asp-controller="Topic" asp-action="Moderate" asp-route-id="@Model.Id" title="Moderate" class="modal-link"><i class="modstatus-@Model.Status fa fa-hand-stop-o"></i></a>
        </div>
        <div class="card-body">
            <div class="body topic">
                <partial name="PostAuthor" model="Model.Author"/>
                <div class="content flex-shrink-0 flex-grow-0">
                    @if (eventservice != null && eventservice.EnabledForTopic(Model.Id))
                    {
                        @await Component.InvokeAsync("Events", new { template = "TopicSummary", id = Model.Id })
                    }
                    @if (Model.HasPoll)
                    {
                        <div id="PollPanel">
                        @await Component.InvokeAsync("Polls", new { template = "DisplayPoll", catid = 0, forumid = 0, topicid = Model.Id })
                        </div>
                    }
                    @Html.Raw(BbCodeProcessor.Format(Model.Content))
                    @if (Model.ShowSig)
                    {
                        <div class="author-sig">@Html.Raw(BbCodeProcessor.Format(Model.Author.Signature))</div>
                    }
                </div>

            </div>
        </div>
        <div snitz-if="@(User.Identity.IsAuthenticated || Model.Edited != null)" class="card-footer text-dark">
            <span snitz-if="@(SnitzConfig.GetIntValue("STREDITEDBYDATE") == 1 && Model.Edited != null)" class="form-text">@Localizer["lblEditedBy", Model.EditedBy!, Model.Edited!]</span>
                @if (!Model.Archived)
                {
                    @await Component.InvokeAsync("PostControls", new { post = Model })
                    
                }else{
                    <span class="form-text">@Localizer["tipTopicArchived"]</span>
                }
            <div snitz-if="@SnitzConfig.GetIntValue("STRSHOWTOPICNAV") == 1" class="footer"><a href="" class="form-control-plaintext" title="Prev Topic"><i class="fa fa-step-backward"></i></a> <a class="form-control-plaintext text-end" href="" title="Next Topic"><i class="fa fa-step-forward"></i></a> </div>
        </div>
    </div>

<!--Replies Section-->
@if (Model.Replies != null && Model.Replies!.Any())
{
    <form id="defaultdays-form" asp-action="Index" class="form-inline">
        <div class="input-group">
            <span class="form-text">&nbsp;@Localizer["selSortDir"] &nbsp;</span>
            <select class="form-select mb-2" id="sortdir" name="sortdir">
                <option value="des" selected-val="@Model.SortDir">@Localizer["optDesc"]</option>
                <option value="asc" selected-val="@Model.SortDir">@Localizer["optAsc"]</option>
            </select>
            @if (SnitzConfig.GetValueWithDefault("STRTOPICPAGESIZES", "") != "")
            {
                var ischecked = Model.PageSize;
                    <span class="form-text">&nbsp;@Localizer["lblPageSize"]&nbsp;</span>

                <div class="radioBtn btn-group" role="group" aria-label="Select page size" title="Select page size">
                    @foreach (var size in SnitzConfig.GetValueWithDefault("STRTOPICPAGESIZES", "").Split(","))
                    {
                        <input type="radio" class="btn-check" name="pagesize" id="option_@size" autocomplete="off" value="@size"
                               @if (ischecked == Convert.ToInt32(size))
                               {
                                   @Html.Raw("checked")
                               }/>
                        <label class="btn btn-outline-secondary mb-2" for="option_@size">@size</label>
                    }
                </div>
            }
        </div>
        <input type="number" value="@pagenum" name="page" style="display: none;"/>
    </form>

    var rowclass = "alt";
    var first = true;
    <div class="reply-container">

        @foreach (var reply in Model.Replies!)
        {
            rowclass = rowclass == "alt" ? "" : "alt";
            var hideme = "";
            var inneranswer = "";
            var viewUnmoderated = reply.Status < 2;
            if (reply.Answer)
            {
                        inneranswer = "bg-success";
            }
            if (!first)
            {
                hideme = "display:none;";
            }
            first = false;
            @if ((User.IsInRole("Administrator") || User.IsInRole("Forum_" + Model.ForumId) || reply.AuthorName == User.Identity.Name))
            {
                viewUnmoderated = true;
            }
            <div class="card mb-3 reply-card " snitz-if="@viewUnmoderated">
                <div style="@hideme">
                            <div class="card-header @inneranswer modstatus-@reply.Status">
                        @Localizer["lblPosted"] <snitz-datetime datetime="@reply.Created"></snitz-datetime>
                        <a snitz-if="@((User.IsInRole("Administrator") || User.IsInRole("Forum_" + Model.ForumId)) && reply.Status == 2)" asp-controller="Reply" asp-action="Moderate" asp-route-id="@reply.Id" title="Moderate" class="modal-link"><i class="modstatus-@reply.Status fa fa-hand-stop-o"></i></a>
                        <a snitz-if="@((User.IsInRole("Administrator") || User.IsInRole("Forum_" + Model.ForumId)) && reply.Status == 3)" asp-controller="Reply" asp-action="Moderate" asp-route-id="@reply.Id" title="Moderate" class="modal-link"><i class="modstatus-@reply.Status fa fa-pause"></i></a>
                        <span class="pull-right">
                            <i class="fa fa-object-ungroup split-topic" data-id="@reply.Id" data-topic="@Model.Id" title="@Localizer["tipSplitTopic"]" style="display: none;"></i>
                            <input type="checkbox" class="form-check-input reply-select" value="@reply.Id" name="replyselected" />
                        </span>
                    </div>
                    <div class="card-body" id="reply-@reply.Id">
                        <div class="body @rowclass">
                            <partial name="PostAuthor" model="reply.Author"/>
                            <div class="content">
                                @Html.Raw(BbCodeProcessor.Format(reply.Content))
                                @if (reply.ShowSig)
                                {
                                    <div class="author-sig">@Html.Raw(BbCodeProcessor.Format(reply.Author.Signature))</div>
                                }
                            </div>
                        </div>
                    </div>
                    <div snitz-if="@(User.Identity.IsAuthenticated || reply.Edited != null)" class="card-footer text-dark">
                        <span snitz-if="@(SnitzConfig.GetIntValue("STREDITEDBYDATE") == 1 && reply.Edited != null)" class="form-text">@Localizer["lblEditedBy", reply.EditedBy!, reply.Edited!]</span>
                        @if(!Model.Archived)
                        {
                            @await Component.InvokeAsync("PostControls", new { post = reply})         
                        }else{
                            <span class="form-text">@Localizer["tipTopicArchived"]</span>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
    <!--Pagination starts-->
    @if (Model.PageCount > 1)
    {
        <partial name="ListPaging" model="@(new PagingModel{
                                            PageCount = Model.PageCount,
                                            PageSize = Model.PageSize,
                                            Page = Model.PageNum,
                                            OrderBy = "lpd",
                                            SortDir = Model.SortDir})" />
    }
    else
    {
        <div class="mb3">&nbsp;</div>
    }
}
else
{
    <p snitz-if="@(User.Identity.IsAuthenticated && !Model.IsLocked)" class="p-4">@Localizer["lblNoReplyMessage"]</p>
    <p snitz-if="@(!User.Identity.IsAuthenticated && !Model.IsLocked)" class="p-4">@Localizer["lblNoReplies"]</p>
}
    <!--Reply Area-->
    @if (SnitzConfig.GetIntValue("STRSHOWQUICKREPLY") == 1 && !Model.Archived)
    {
        <div snitz-if="@(!Model.IsLocked)" class="comment-area @replyClass mt-2" id="reply-area">
            <form asp-controller="Topic" asp-action="AddReply" class="needs-validation" id="QuickReply" novalidate>
                <textarea name="Content" id="msg-text" placeholder="reply here ... " class="form-control" required="required" rows="6"></textarea>
                <div class="invalid-feedback text-danger-emphasis">@Localizer["MessageRequired"]</div>
                <input name="TopicId" type="hidden" value="@Model.Id"/>
                <input asp-for="ForumId" type="hidden"/>
                <div class="mb-3 p-3 row">
                    @if (SnitzConfig.GetIntValue("STRSIGNATURES") == 1 && currmember != null)
                    {
                        <div class="col-6 form-check">
                            <input class="form-check-input" id="show-sig" name="UseSignature" tabindex="5" type="checkbox" value="true" checked="@(currmember.SigDefault == 1)">
                            <input name="UseSignature" type="hidden" value="false">
                            <label class="form-check-label mt-1" for="show-sig">&nbsp;@Localizer["cbxShowSig"]</label>
                        </div>
                    }
                    @if (User.IsInRole("Administrator"))
                    {
                        <div class="col-6 form-check">
                            <input class="form-check-input" asp-for="IsLocked" tabindex="5" type="checkbox" checked="@Model.IsLocked">
                            <label class="form-check-label mt-1" for="IsLocked">&nbsp;@Localizer["cbxLockTopic"]</label>
                        </div>
                        @if (SnitzConfig.GetIntValue("STRSTICKYTOPIC") == 1)
                        {
                            <div class="col-6 form-check">
                                <input class="form-check-input" asp-for="IsSticky" tabindex="5" type="checkbox" checked="@Model.IsSticky">
                                <label class="form-check-label mt-1" for="IsSticky">&nbsp;@Localizer["cbxMakeSticky"]</label>
                            </div>
                        }
                    }
                    <div class="col-6 form-check" style="display: none;">
                        <input class="form-check-input" id="SaveDraft" name="SaveDraft" tabindex="5" type="checkbox" value="true"><input name="SaveDraft" type="hidden" value="false">
                        <label class="form-check-label mt-1">@Localizer["cbxDraft"]</label>
                    </div>
                </div>
                <div class="mb-3 mt-2">
                    <button type="reset" class="btn btn-warning">@Localizer["btnReset"]</button>
                    <button type="submit" class="btn  btn-success">@Localizer["btnPost"]</button>
                </div>
            </form>
        </div>
    }

</div>
}

<div id="memberModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-bg-dark">
                <a href="#" data-bs-dismiss="modal" aria-hidden="true" class="btn btn-outline-light">X</a>
                <h4 class="bg-dark text-bg-dark" id="modal-title"></h4>
            </div>
            <div class="modal-body">
                <div id="member-modal"></div>
            </div>
            <div class="modal-footer">
                <a href="#" id="btnOk" class="btn btn-danger">@Localizer["btnOk"]</a>
                <a href="#" data-bs-dismiss="modal" aria-hidden="true" class="btn btn-secondary">@Localizer["btnCancel"]</a>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="moderateModal" tabindex="-1" aria-labelledby="moderateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" id="posModeration"></div>
    </div>
</div>
@{
    var confModel = new ConfirmDialogViewModel()
    {
        Title = Localizer["popManageTopicTitle"].Value, // "Manage Topic",
        Message = @"<p></p>"
    };
    <partial name="ConfirmDialog" model="@confModel" />
}
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">
                    @Localizer["lblFileUpload"]
                </h5> 
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="upload-content"></div>
            </div>
            <div class="modal-footer">
                <p class="footer-title">If you're having problems uploading, try choosing a smaller image.</p>
            </div>
        </div>
    </div>
</div>
<!-- Send Topic Popup -->
@if (SnitzConfig.GetIntValue("STRSHOWSENDTOFRIEND") == 1)
{
    <div id='modal-sendto' class='modal fade in' tabindex="-1" data-url='@Url.Action("SendTo", "Topic")' aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">
                        @Localizer["dlgSendTopic"]
                    </h5> 
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id='sendToContainer' class="modal-body">
                    <div class="container text-center">
                        <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
<input type="text" style="display: none;" id="req-auth" value="@ViewBag.RequireAuth.ToString()" />
<input type="text" style="display: none;" id="req-forumid" value="@Model.ForumId" />
<partial name="PasswordDlg" model='new ConfirmDialogViewModel(){Title=Localizer["popPasswordRqdTitle"].Value,Message = Localizer["popPasswordRqdMessage"].Value}' />

@section Scripts
{
    <script>
        let ContentFolder = "~/Content/PhotoAlbum/";
        if ('@SnitzConfig.GetIntValue("INTPROTECTPHOTO")' == '1') {
            ContentFolder = "~/@SnitzConfig.ContentFolder/PhotoAlbum/"
        }
    </script>
    <script type="text/javascript" src="~/js/postcontroller.js"></script>
    <script type="text/javascript" src="~/js/tinymce/tinymce.min.js"></script>
    <script type="text/javascript" src="~/js/initPostForm.js"></script>
    <script type="text/javascript" src="~/js/prism.js" data-manual></script>
    <script type="text/javascript" src="~/js/topic.min.js"></script>
    <script type="text/javascript">
        $(window).on("load",
            function (e) {
                $("#passwordDlg").on('hide.bs.modal',
                    function () {
                        alert("close");
                        window.location.href = '/Category/Index';
                    });
                $('#passwordDlg').on('click',
                    '#btnPassYes',
                    function (e) {
                        $.ajax({
                            type: "POST",
                            url: '/Forum/PasswordCheck',
                            data: { pwd: $('#forum-pass').val(), forumid: $('#req-forumid').val(), topicid: '0' },
                            success: function (result) {
                                alert(result);
                                if (result) {
                                    $("#passwordDlg").off('hide.bs.modal');
                                    location.reload(true);
                                    $('#passwordDlg').modal('hide');
                                    return false;
                                } else {
                                    window.location.href = '/Category/Index';
                                }
                            },
                            error: function (error) {
                                alert(error);
                                window.location.href = '/Category/Index';
                                return false;
                            }
                        });
                    });
                if ($('#req-auth').val() === 'True') {
                    $('#passwordDlg').modal('show');
                }
                $('.split-topic').on('click', function (e) {
                    e.preventDefault();
                    location.href = "~/Topic/SplitTopic/?id=" + $(this).data("topic") + "&replyid=" + $(this).data("id");
                });
            });

        $("#QuickReply").submit(function (e) {
            e.preventDefault();

            tinyMCE.get("msg-text").save();
            var form = $("#QuickReply");
            var formData = new FormData(form[0]);
            $.ajax({
                url: $(this).attr("action"),
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function (data) {
                    location.href = data.url;
                },
                error: function (err) {
                    console.log(err);
                }
            });
            return false;
        });
    </script>
    <renderstoredcontent asp-key="topic-post-controls"></renderstoredcontent>
}