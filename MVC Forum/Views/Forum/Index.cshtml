@model MVCForum.ViewModels.Forum.ForumTopicModel
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using MVCForum.TagHelpers
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using MVCForum.TagHelpers
@using SnitzCore.Service.TagHelpers
@inject SignInManager<ForumUser> SignInManager
@section MetaData
{
    <meta name="title" content="Forum: @Model.Forum?.Title" />
    <meta name="description" content="@Model.Forum?.Description" />
    <meta name="robots" content="index,nofollow" />
}
@{
    ViewBag.PageCount = Model.PageCount;
    var pagenum = Model.PageNum?.ToString() ??  Context.Request.Query["page"];
    var pagesize = Context.Request.Query["pagesize"];
    ViewBag.PageSize = pagesize.Count < 1 ? 20 : Convert.ToInt32(pagesize);
    ViewBag.PageNum = pagenum;
    if (Model.AccessDenied)
    {
        if (!SignInManager.IsSignedIn(User))
        {
            <div class="container">
                <h3>You do not have access to this forum, please try <a href="/Account/Login">logging in</a> first</h3>
            </div>
        }
        else
        {
            <div class="container">
                <h3>You do not have access to this forum</h3>
            </div>
        }

        return;
    }
    if (Model.PasswordRequired)
    {
        <div class="container">
            <h2>This Forum needs a password</h2>
        </div>
        return;
    }

}
<div class="container pt-0">
    <snitz-breadcrumb class="d-none d-sm-block"></snitz-breadcrumb>
    <form id="defaultdays-form" asp-action="Index" class="form-inline">
        <div class="row m-1">
            <div class="input-group forum">
                <enum-select id="default-days" enum-type="typeof(DefaultDays)" selected-value="(int)Model.Forum.DefaultView" text-localizer-delegate="delegate(string s) { return Localizer[s].Value; }"></enum-select>
                <select name="OrderBy" id="orderby" class="form-select mb-2" title="Order by" aria-invalid="false">
                    <option value="pd" selected-val="@Model.Forum?.OrderBy">@Localizer["optPostDate"]</option>
                    <option value="lpd" selected-val="@Model.Forum?.OrderBy">@Localizer["optLastPostDate"]</option>
                    <option value="a" selected-val="@Model.Forum?.OrderBy">@Localizer["optAuthor"]</option>
                    <option value="lpa" selected-val="@Model.Forum?.OrderBy">@Localizer["optLastAuthor"]</option>
                    <option value="v" selected-val="@Model.Forum?.OrderBy">@Localizer["optViews"]</option>
                    <option value="r" selected-val="@Model.Forum?.OrderBy">@Localizer["optReplies"]</option>
                </select>
                <select name="sortdir" id="sortdir" class="form-select mb-2" title="Sort direction" aria-invalid="false">
                    <option value="asc" selected-val="@Model.Forum?.SortDir">@Localizer["optAsc"]</option>
                    <option value="des" selected-val="@Model.Forum?.SortDir">@Localizer["optDesc"]</option>
                </select>
                @if (SnitzConfig.GetValue("STRFORUMPAGESIZES", "") != "")
                {
                    var ischecked = Model.PageSize;
                    <span class="form-text mb-2 d-none d-sm-block">&nbsp;@Localizer["lblPageSize"]&nbsp;</span>

                    <div class="radioBtn btn-group d-none d-sm-block" role="group" aria-label="Select page size" title="Select page size">
                        @foreach (var size in SnitzConfig.GetValue("STRFORUMPAGESIZES", "").Split(","))
                        {
                            <input type="radio" class="btn-check" name="pagesize" id="option_@size" autocomplete="off" value="@size" @if(ischecked == Convert.ToInt32(size)){@Html.Raw("checked")} />
                            <label class="btn btn-outline-secondary mb-2" for="option_@size">@size</label>

                        }
                    </div>
                }
                <span class="input-group-append">
                    <div class="btn-group">
                        <button snitz-if="@Model.Forum?.Status==1" asp-controller="Topic" asp-action="Create" asp-route-id="@Model.Forum?.Id" class="btn btn-primary"><i class="fa fa-commenting-o"></i><span class="d-none d-md-inline"> @Localizer["btnNewTopic"]</span></button>
                        @if (User.IsInRole("Administrator"))
                        {
                            <button asp-controller="Forum" asp-action="Edit" asp-route-id="@Model.Forum!.Id" title="Edit Forum" class="btn  btn-outline-warning"><i class="fa fa-pencil"></i><span class="d-none d-md-inline"> @Localizer["tipEditForum"]</span></button>
                            <button-confirm selector="confirm-delete" config-class="fa fa-trash" config-key="@Model.Forum!.Id" href="/Forum/Delete/?id=" title="@Localizer["cnfDeleteForum"].Value"></button-confirm>
                        }
                    </div>
                </span>
            </div>
        </div>
        <input type="number" value="@Model.Forum?.Id" name="id" style="display: none;"/>
        <input type="number" value="@pagenum" name="page" style="display: none;" />
        <input type="number" value="0" name="defaultdays" id="hdndefaultdays" style="display: none;" />
    </form>
    <!--Display posts table-->
    <div class="posts-table">
        <div class="table-head">
            <div class="status rounded-2"></div>
            <div class="subjects rounded-2">@Localizer["lblSubject"]</div>
            <div class="replies rounded-2">@Localizer["lblReplies"] / @Localizer["lblViews"]</div>
            <div class="last-reply rounded-2">@Localizer["lblLastPost"]</div>
        </div>
        @{
            ViewData["ActiveTopics"] = false;
        }
        <!--Sticky Topics-->
        @if (Model.StickyPosts!.Any())
        {
            if (Model.StickyPosts != null)
            {
                foreach (var post in Model.StickyPosts)
                {
                    <partial name="TopicListing" model="post" view-data="ViewData" />
                }
            }
            <hr />
        }
        <!--Topics start here-->
        @foreach (var post in Model.Posts!){
            <partial name="TopicListing" model="post" view-data="ViewData" />
        }
        @if (Model.Forum.Posts == 0)
        {
            <p class="text-center p-4">@Localizer["lblNoForumTopics"]</p>
        }else if (Model.Posts == null || Model.Posts?.Count() == 0)
        {
            <p class="text-center p-4">@Localizer["lblNoTopicsToDisplay"]</p>
        }
        <!--ends here-->
    </div>
    <!--Pagination starts-->
    <partial snitz-if="@(Model.PageCount > 1)" 
             name="ListPaging" 
             model="@(new PagingModel
                                    {
                                        PageCount = Model.PageCount,
                                        Page = pagenum != null ? Convert.ToInt32(pagenum) : 1,
                                        OrderBy = Model.Forum!.OrderBy,
                                        SortDir = Model.Forum.SortDir,
                                        DefaultDays = (int)Model.Forum.DefaultView
                                    })" />
    <!--pagination ends-->
    <partial name="IconInfo" />
</div>
@{
    var confModel = new ConfirmDialogViewModel()
    {
        Title = "Delete Forum",
        Message = $@"<p>You are about to delete the Forum {Model.Forum!.Title}</p>
        <p>Do you wish to proceed?</p>"
    };
}
<partial name="ConfirmDialog" model="@confModel" />

@section Scripts {
    <script type="text/javascript" src="/js/ConfirmDialog.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
        $(document).on("change", "#default-days", function () {
                $("#hdndefaultdays").val($(this).val());
                $("#defaultdays-form").submit();
            });
        $(document).on("change", "#orderby", function () {
                $("#hdndefaultdays").val($("#default-days").val());
                $("#defaultdays-form").submit();
            });
        $(document).on("change", "input[type=radio][name=pagesize]", function () {
                $("#defaultdays-form").submit();
            });
        $(document).on("change", "#sortdir", function () {
                $("#hdndefaultdays").val($("#default-days").val());
                $("#defaultdays-form").submit();
            });
    </script>
}