@model MVCForum.Models.Forum.ActiveTopicModel
@using BbCodeFormatter
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using MVCForum.Extensions
@using MVCForum.Models
@using MVCForum.TagHelpers
@using SmartBreadcrumbs
@using SnitzCore.Data
@using SnitzCore.Data.Extensions
@using SnitzCore.Data.Models
@inject ICodeProcessor BbCodeProcessor
@inject IMember MemberService

@section MetaData
{
    
}
@{
    ViewBag.PageCount = Model.PageCount;
    var pagenum = Model.PageNum?.ToString() ?? Context.Request.Query["page"];
    var pagesize = Context.Request.Query["pagesize"];
    var lastvisit = DateTime.UtcNow;
    if (User.Identity.IsAuthenticated)
    {
        lastvisit = MemberService.GetByUsername(User.Identity.Name).Lastheredate.FromForumDateStr();
    }

    var refresh = ViewBag.RefreshSeconds;
}

<div class="container pt-0">
    <breadcrumb></breadcrumb>
    <form id="defaultdays-form" asp-action="Active" class="form-inline">
        <div class="row m-2">
            <div class="col col-md-6">
                <div class="input-group mb-3">
                    <select asp-for="Since" id="default-days"
                            class="form-select mb-2 mr-sm-2"
                            asp-items="Html.GetEnumSelectList<ActiveSince>()">
                    </select>
                    <select asp-for="Refresh" id="active-refresh"
                            class="form-select mb-2 mr-sm-2"
                            asp-items="Html.GetEnumSelectList<ActiveRefresh>()">
                    </select>
                    <input type="submit" class="btn btn-success mb-2"/>
                </div>
            </div>
        </div>
        @*<input type="number" value="@Model?.Forum?.Id" name="id" style="display: none;"/>*@
        <input type="number" value="@pagenum" name="page" style="display: none;"/>
        <input type="number" value="@pagesize" name="pagesize" style="display: none;"/>
        <input type="number" value="0" name="defaultdays" id="hdndefaultdays" style="display: none;"/>
    </form>
    @if (Model.Posts.Any())
    {
        <!--Display posts table-->
        <div class="posts-table">
            <div class="table-head">
                <div class="status"></div>
                <div class="subjects">Subjects</div>
                <div class="replies">Replies / Views</div>
                <div class="last-reply">Last Reply</div>
            </div>
            <!--Topics start here-->
            @foreach (var post in Model.Posts)
            {
                <partial name="_TopicListing" model="post" />

            }



            <!--ends here-->
        </div>
        <!--Pagination starts-->
        @if (Model.PageCount > 1)
        {
            var paging = new PagingModel
            {
                PageCount = Model.PageCount,
                Page = pagenum != null ? Convert.ToInt32(pagenum) : 1,
                //OrderBy = "lpd",
                //SortDir = "des",
                //DefaultDays = (int)Model.ActiveSince
            };
            @await Html.PartialAsync("ListPaging", paging)
        }
        <!--pagination ends-->
    }
    else
    {
        <div class="center"><h4>No active Posts</h4></div>
    }
    <partial name="_IconInfo" />
</div>


@section Scripts{
    <script>
        $(document).on("change",
            "#default-days",
            function() {
                $("#hdndefaultdays").val($(this).val());
                $("#defaultdays-form").submit();
            });
        $(document).ready(function() {
            $('select option:contains("Last Visit")').text("Last Visit " + '(@lastvisit.ToLocalTime().ToForumDisplay()) ');
        });
        var refresh = '@refresh';

        if (refresh.length && refresh > 0) {
            setInterval("window.location.reload();", refresh);
        }
    </script>
}
