@using SnitzCore.BackOffice.TagHelpers
@using SnitzCore.Data.Models
@model List<MemberNamefilter>

@{
    Layout = "AdminLayout";
 
}
@section Styles{
    <style>
        .input-group > input.cpick {
            flex: 0 1 50px;
        }
    </style>
    <style>

        /* Main CSS */
        .grid-wrapper > div {
            display: flex;
            justify-content: center;
            align-items: center;
        }

            .grid-wrapper > div > figure {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .grid-wrapper > div > img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .grid-wrapper {
            display: grid;
            grid-gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            grid-auto-rows: 120px;
            grid-auto-flow: dense;
        }

            .grid-wrapper .wide {
                grid-column: span 2;
            }

            .grid-wrapper .tall {
                grid-row: span 2;
            }

            .grid-wrapper .big {
                grid-column: span 2;
                grid-row: span 2;
            }

    </style>
}

<div class="m-3">
    <div class="nav nav-tabs me-3" id="v-pills-tab" role="tablist">
        <button class="nav-link active" id="v-pills-home-tab" data-bs-toggle="pill" data-bs-target="#v-pills-home" type="button" role="tab" aria-controls="v-pills-home" aria-selected="true">Profile</button>
        <button class="nav-link" id="v-pills-roles-tab" data-bs-toggle="pill" data-bs-target="#v-pills-roles" type="button" role="tab" aria-controls="v-pills-roles" aria-selected="false">Roles</button>
        <button class="nav-link" id="v-pills-ranking-tab" data-bs-toggle="pill" data-bs-target="#v-pills-ranking" type="button" role="tab" aria-controls="v-pills-ranking" aria-selected="false">Ranking</button>
        <button class="nav-link" id="v-pills-subscriptions-tab" data-bs-toggle="pill" data-bs-target="#v-pills-subscriptions" type="button" role="tab" aria-controls="v-pills-subscriptions" aria-selected="false">Subscriptions</button>
        <button class="nav-link" id="v-pills-usernames-tab" data-bs-toggle="pill" data-bs-target="#v-pills-usernames" type="button" role="tab" aria-controls="v-pills-usernames" aria-selected="false">Username Filters</button>
        <button class="nav-link" id="v-pills-pending-tab" data-bs-toggle="pill" data-bs-target="#v-pills-pending" type="button" role="tab" aria-controls="v-pills-pending" aria-selected="false">Pending Members</button>
        <button class="nav-link" id="v-pills-avatars-tab" data-bs-toggle="pill" data-bs-target="#v-pills-avatars" type="button" role="tab" aria-controls="v-pills-avatars" aria-selected="false">Avatars</button>
    </div>
    <div class="tab-content bg-white p-4" id="v-pills-tabContent">
        <div class="tab-pane fade show active w-100" id="v-pills-home" role="tabpanel" aria-labelledby="v-pills-home-tab">
            <form asp-action="SaveMemberSettings" asp-controller="SnitzConfig" method="POST" data-ajax="true" data-ajax-update="#result">
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRFULLNAME" config-label="Fullname" config-val="@SnitzConfig.GetIntValue("STRFULLNAME")" help-text="@Localizer["STRFULLNAME"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQFULLNAME" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQFULLNAME")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRAGE" config-label="Age" config-val="@SnitzConfig.GetIntValue("STRAGE")" help-text="@Localizer["STRAGE"].Value"></admin-config>
                </div>
                <div class="col">
                        <admin-config config-key="STRREQAGE" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQAGE")" ></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRAGEDOB" config-label="Date of Birth" config-val="@SnitzConfig.GetIntValue("STRAGEDOB")" help-text="@Localizer["STRAGEDOB"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQAGEDOB" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQAGEDOB")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRMINAGE" config-label="Min Age" config-val="@SnitzConfig.GetIntValue("STRMINAGE")" help-text="@Localizer["STRMINAGE"].Value"></admin-config>
                </div>
                <div class="col">

                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRSEX" config-label="Gender" config-val="@SnitzConfig.GetIntValue("STRSEX")" help-text="@Localizer["STRSEX"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQSEX" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQSEX")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRMARSTATUS" config-label="Marital Status" config-val="@SnitzConfig.GetIntValue("STRMARSTATUS")" help-text="@Localizer["STRMARSTATUS"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQMARSTATUS" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQMARSTATUS")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRCITY" config-label="City" config-val="@SnitzConfig.GetIntValue("STRCITY")" help-text="@Localizer["STRCITY"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQCITY" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQCITY")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRSTATE" config-label="State" config-val="@SnitzConfig.GetIntValue("STRSTATE")" help-text="@Localizer["STRSTATE"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQSTATE" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQSTATE")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRCOUNTRY" config-label="Country" config-val="@SnitzConfig.GetIntValue("STRCOUNTRY")" help-text="@Localizer["STRCOUNTRY"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQCOUNTRY" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQCOUNTRY")"></admin-config>
                </div>
            </div>
            <hr/>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRPICTURE" config-label="Avatar" config-val="@SnitzConfig.GetIntValue("STRPICTURE")" help-text="@Localizer["STRPICTURE"].Value"></admin-config>
                </div>
                <div class="col">
                        <admin-config config-key="STRREQPICTURE" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQPICTURE")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STROCCUPATION" config-label="Occupation" config-val="@SnitzConfig.GetIntValue("STROCCUPATION")" help-text="@Localizer["STROCCUPATION"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQOCCUPATION" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQOCCUPATION")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRHOMEPAGE" config-label="Homepage" config-val="@SnitzConfig.GetIntValue("STRHOMEPAGE")" help-text="@Localizer["STRHOMEPAGE"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQHOMEPAGE" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQHOMEPAGE")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRBIO" config-label="Bio" config-val="@SnitzConfig.GetIntValue("STRBIO")" help-text="@Localizer["STRBIO"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQBIO" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQBIO")"></admin-config>
                </div>
            </div>
            <!-- Messenger Links -->
            <hr/>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRAIM" config-label="AIM" config-val="@SnitzConfig.GetIntValue("STRAIM")" help-text="@Localizer["STRAIM"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQAIM" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQAIM")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRICQ" config-label="ICQ" config-val="@SnitzConfig.GetIntValue("STRICQ")" help-text="@Localizer["STRICQ"].Value"></admin-config>
                </div>
                <div class="col">
                        <admin-config config-key="STRREQICQ" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQICQ")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRMSN" config-label="Skype (was MSN)" config-val="@SnitzConfig.GetIntValue("STRMSN")" help-text="@Localizer["STRMSN"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQMSN" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQMSN")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRYAHOO" config-label="YAHOO!" config-val="@SnitzConfig.GetIntValue("STRYAHOO")" help-text="@Localizer["STRYAHOO"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQYAHOO" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQYAHOO")"></admin-config>
                </div>
            </div>
            <hr/>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRFAVLINKS" config-label="Favorite Links" config-val="@SnitzConfig.GetIntValue("STRFAVLINKS")" help-text="@Localizer["STRFAVLINKS"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQFAVLINKS" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQFAVLINKS")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRHOBBIES" config-label="Hobbies" config-val="@SnitzConfig.GetIntValue("STRHOBBIES")" help-text="@Localizer["STRHOBBIES"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQHOBBIES" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQHOBBIES")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRLNEWS" config-label="Latest News" config-val="@SnitzConfig.GetIntValue("STRLNEWS")" help-text="@Localizer["STRLNEWS"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQLNEWS" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQLNEWS")"></admin-config>
                </div>
            </div>
            <div class="row">
                <div class="col">
                        <admin-config config-key="STRQUOTE" config-label="Quote" config-val="@SnitzConfig.GetIntValue("STRQUOTE")" help-text="@Localizer["STRQUOTE"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRREQQUOTE" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRREQQUOTE")"></admin-config>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col">
                        <admin-config config-key="STRRECENTTOPICS" config-label="Recent Topics" config-val="@SnitzConfig.GetIntValue("STRRECENTTOPICS")" help-text="@Localizer["STRRECENTTOPICS"].Value"></admin-config>
                </div>
                <div class="col">
                    <admin-config config-key="STRRECENTTOPICS" config-label="Required" config-val="@SnitzConfig.GetIntValue("STRRECENTTOPICS")"></admin-config>
                </div>
            </div>
            <div class="mb-3">
                    <button type="reset" class="btn btn-outline-warning">Reset</button>
                    <button type="submit" class="btn btn-outline-success">Save</button>
            </div>
            </form>
        </div>
        <div class="tab-pane fade" id="v-pills-usernames" role="tabpanel" aria-labelledby="v-pills-usernames-tab">
            <legend>Username Filter</legend>
            <hr />
            <form asp-action="SaveUsername" asp-controller="SnitzConfig" method="POST" data-ajax="true" data-ajax-update="#result-namefilters">

                <div class="mb-3">
                    <label class="form-label">Add name to disallow</label>
                    <div class="input-group mb-3">
                        <input type="text" name="Username" class="form-control" placeholder="Name to disallow" aria-label="Name to disallow" aria-describedby="button-addon2">
                        <button class="btn btn-outline-warning" type="reset">Cancel</button>
                        <button class="btn btn-outline-success" type="submit">Add</button>
                    </div>
                </div>
            </form>
            <form asp-action="UpdateUsernameFilter" asp-controller="SnitzConfig" id="userfilterForm" method="POST" data-ajax="true" data-ajax-update="#result-namefilters">
                <ul class="list-group mb-3">
                    @for (int i = 0; i < Model?.Count; i++)
                    {
                        <li class="list-group-item filter_@i">
                            <div class="input-group">
                                <input type="hidden" asp-for="@Model[i].Id" />
                                <input type="hidden" asp-for="@Model[i].IsDeleted" />
                                <input type="text" class="form-control" asp-for="@Model[i].Name" />
                                <button class="btn btn-outline-success ButtonType" type="submit" data-filter="@i"><i class="fa fa-trash"></i></button>
                            </div>
                        </li>
                    }
                </ul>
                <div id="result-namefilters"></div>
            </form>
        </div>
        <div class="tab-pane fade" id="v-pills-roles" role="tabpanel" aria-labelledby="v-pills-roles-tab">
            <div id="member-roles"></div>
        </div>
        <div class="tab-pane fade" id="v-pills-ranking" role="tabpanel" aria-labelledby="v-pills-ranking-tab">
            <div id="member-ranking"></div>
        </div>
        <div class="tab-pane fade" id="v-pills-pending" role="tabpanel" aria-labelledby="v-pills-pending-tab">
            <div id="member-pending"></div>
        </div>
        <div class="tab-pane fade" id="v-pills-subscriptions" role="tabpanel" aria-labelledby="v-pills-subscriptions-tab">
            <div id="member-subscriptions"></div>
        </div>
        <div class="tab-pane fade" id="v-pills-avatars" role="tabpanel" aria-labelledby="v-pills-avatars-tab">
            <div id="member-avatars"></div>
        </div>
        <div id="result"></div>
    </div>
</div>

@section Scripts {

    <script type="text/javascript" src="~/js/jquery.unobtrusive-ajax.min.js"></script>
    <script type="text/javascript">

        $(document).on('click','.roleLink',function(e) {
            e.preventDefault();
            $('#member-roles').load($(this).attr('href'), function () {});
        });
        $(document).on('shown.bs.tab',
            'button[data-bs-toggle="pill"]',
            function (e) {
                $('[id^=result]').html('');
                switch (e.target.id) {
                    case "v-pills-ranking-tab":
                        $('#member-ranking').load(SnitzVars.baseUrl + '/SnitzConfig/RankingConfig/' + $(this).val(), function () { });
                        break;
                    case "v-pills-roles-tab":
                        $('#member-roles').load(SnitzVars.baseUrl + '/Admin/ManageRoles/?role=' + $(this).val(), function () { });
                        break;
                    case "v-pills-pending-tab":
                        $('#member-pending').load(SnitzVars.baseUrl + '/Admin/PendingMembers/', function () { });
                        break;
                    case "v-pills-subscriptions-tab":
                        $('#member-subscriptions').load(SnitzVars.baseUrl + '/Admin/ManageSubscriptions/', function () { });
                        break;
                    case "v-pills-avatars-tab":
                        $('#member-avatars').load(SnitzVars.baseUrl + '/Admin/ManageAvatars/', function () { });
                        break;
                }
            });
        $('#myModal').on('show',
            function() {
                var id = $(this).data('id'),
                    removeBtn = $(this).find('.danger');
            });
        $(document).on("change", "#filter-subs", function() {
            $('#member-subscriptions').load(SnitzVars.baseUrl + '/Admin/ManageSubscriptions/' + $(this).val(), function () { });
        });

        $(document).on("change",".cpick",function(){
            var newcol = $(this).val();
            $(this).siblings().find(".fa-star").css({"color": newcol});
        })
        $(document).on('click','.confirm-delete', function(e) {
            e.preventDefault();
            var id = $(this).data('id');
            var href = $(this).attr('href');
            $('#myModal').data('id', id).data('url', href.replace("~", SnitzVars.baseUrl)).modal('show');
        });
        $(document).on('click', '.lnkDelete', function (e) {
            e.preventDefault();
            
            var href = $(this).attr('href');
            $.get(href.replace("~", SnitzVars.baseUrl), function (result) {
                location.reload();
            });
        });
        $(document).on('click', '.lnkApprove', function (e) {
            e.preventDefault();

            var href = $(this).attr('href');
            $.get(href.replace("~", SnitzVars.baseUrl), function (result) {
                location.reload();
            });
        });
        $(document).on('click','#btnYes',function(e) {
            // handle deletion here
            e.preventDefault();
            var url = $('#myModal').data('url');
            $.get(url, function(result) {
                $('#member-roles').html('');
                $('#member-roles').html(result);
                $('#myModal').modal('hide');
            });
            $('#myModal').modal('hide');
        });
        //rank-image
        $(document).on('click','.rank-image', function(e) {
            //
            e.preventDefault();
            const re = new RegExp("icon_star_(.+).gif");
            const myArray = re.exec($(this).data('val'));
            var id = $(this).data('id');
            var val = myArray[1];

            $('#' + id).val(val);
            $('.' + id).removeClass("selected");
            $(this).addClass("selected");
        });
        $("#admin-nav li a.nav-link.active").removeClass("active");
        $("#member-settings").addClass("active");

        $(document).on('click', '#delete-selected', function (e) {
            e.preventDefault();
            $.post(SnitzVars.baseUrl + '/Account/DeleteSelected',
                $('.selector:checkbox:checked').serialize(),
                function (msg) {
                    location.reload();
                });
        });
        $(document).ready(function () {
            $('button[data-bs-toggle="pill"]').on('show.bs.tab', function (e) {
                localStorage.setItem('activeMemberTab', e.target.id);
            });
            var activeTab = localStorage.getItem('activeMemberTab');
            if (activeTab) {

                $("#v-pills-tab .nav-link.active").removeClass("active");
                $("#v-pills-tabContent .tab-pane.active").removeClass("active").removeClass("show");
                $("#v-pills-tab #" + activeTab).addClass("active");
                $("#v-pills-tabContent #" + activeTab.replace("-tab", "")).addClass("active").addClass("show");
                switch (activeTab) {
                    case "v-pills-ranking-tab" :
                        $('#member-ranking').load(SnitzVars.baseUrl + '/SnitzConfig/RankingConfig/' + $(this).val(), function () { });
                        break;
                    case "v-pills-roles-tab":
                        $('#member-roles').load(SnitzVars.baseUrl + '/Admin/ManageRoles/?role=' + $(this).val(), function () { });
                        break;
                    case "v-pills-pending-tab":
                        $('#member-pending').load(SnitzVars.baseUrl + '/Admin/PendingMembers/', function () { });
                        break;
                    case "v-pills-subscriptions-tab":
                        $('#member-subscriptions').load(SnitzVars.baseUrl + '/Admin/ManageSubscriptions/', function () { });
                        break;
                    case "v-pills-avatars-tab":
                        $('#member-avatars').load(SnitzVars.baseUrl + '/Admin/ManageAvatars/', function () { });
                        break;
                }

            }

            $("[data-role=submit]").click(function () {
                $(this).closest("form").submit();
            });

            $(document).on('click', '#approve-selected', function (e) {
                e.preventDefault();
                $.post(SnitzVars.baseUrl + '/Account/ApproveSelected',
                    $('.selector:checkbox:checked').serialize(),
                    function (msg) {

                    });
            });

            $(document).on('click', '.send-email',function () {
                var userid = $(this).data('id');
                $.get(SnitzVars.baseUrl + '/Account/EmailMember/' + userid, function (data) {
                    $('#emailContainer').html(data);
                    $.validator.unobtrusive.parse($("#emailMemberForm"));
                    $('#emailModal').modal('show');
                });
            });
        });

        $(document).on('click', '.stopForumSpam', function (evt) {
            //console.log("spam click");
            evt.preventDefault();
            $('#popModalLabel').html('Stop Forum Spam lookup');
            var content = "<div class=\"container text-center\"><i class=\"fa fa-spinner fa-pulse fa-3x fa-fw\" ></i><span class=\"sr-only\"> Loading...</span></div>";
            $('#popContainer').html(content);
            $('#popModal').modal('show');

            var id = $(this).data('id');
            var ip = $(this).data('ip');
            var email = $(this).data('email');
            $.get(SnitzVars.baseUrl + '/Admin/StopForumSpamCheck/' + id + "/?email=" + email + "&userip=" + ip, function (data) {
                $('#popContainer').html(data);

            });
            return false;
        });
        $(document).on('click', '.showIPAddress', function () {
            $('#popModalLabel').html('IP/Domain name');
            var content = "<div class=\"container text-center\"><i class=\"fa fa-spinner fa-pulse fa-3x fa-fw\" ></i><span class=\"sr-only\"> Loading...</span></div>";
            $('#popContainer').html(content);
            $('#popModal').modal('show');

            var ip = $(this).data('id');
            $.get(SnitzVars.baseUrl + '/Account/ResolveIP/?ip=' + ip, function (data) {
                $('#popContainer').html(data);
            });
        });

        $(document).on('click', '.del-avatar', function () {
            var id = $(this).data('id');
            var img = $(this).data('img');
            (async () => {
                const result = await b_confirm('@Localizer["msgConfirmDeleteAvatar"]')
                if (result) {
                    $.ajax({
                        url: '@Url.Action("DeleteAvatar", "Admin")',
                        type: 'POST',
                        data: { id: id, img: img },
                        success: function (response) {
                            if (response.success) {
                                location.reload();
                            } else {
                                alert(response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            alert(error);
                        }
                    });
                }
            })();

        });

    </script>
}